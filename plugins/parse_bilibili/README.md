# B站内容解析插件 (parse_bilibili)

这是一个功能强大的B站内容解析插件，支持视频、直播、专栏/动态、番剧等多种B站内容的解析和下载功能。

## 功能特点

### 1. 被动解析

自动监听消息中的B站链接，并发送解析结果（可配置渲染成图片）。

- 支持多种内容类型：
  - 视频 (av/BV号)
  - 直播
  - 专栏 (cv号)
  - 动态 (t.bili/opus)
  - 番剧/影视 (ss/ep号)
  - 用户空间 (space)
- 支持短链接 (b23.tv)
- 支持小程序/卡片解析（可配置开启/关闭）
- 默认配置下，5分钟内同一链接在同一会话不重复解析

### 2. 手动视频下载

使用命令手动下载B站视频：

```bash
bili下载 [链接/ID]
b站下载 [链接/ID]
```

- 支持视频链接、av/BV号、引用包含链接的消息或卡片
- 支持视频大小检测和自动质量调整，当视频大小超过100MB时自动降低分辨率
- 支持视频缓存功能，已下载过的视频会被缓存，再次下载时直接从缓存发送
- 可通过配置项设置下载视频的质量(16=360P, 32=480P, 64=720P, 80=1080P)
- 支持网络错误自动重试和超时处理，提高下载成功率

### 3. 自动下载控制

管理员可以控制群聊中的自动下载功能：

```bash
bili自动下载 on    # 为当前群聊开启视频自动下载
bili自动下载 off   # 为当前群聊关闭视频自动下载
```

- 开启后，当被动解析到视频链接时，会自动执行下载并发送视频文件
- 自动下载功能支持视频时长限制，默认仅下载10分钟以内的视频
- 支持视频大小检测和自动质量调整，当视频大小超过100MB时自动降低分辨率

### 4. 获取封面图片

获取B站视频或番剧的原始封面图片：

```bash
bili封面  # 获取B站视频/番剧的原始封面图片
b站封面  # 同上，别名命令
```

- **使用方法**：引用包含B站链接的消息，然后发送封面命令
- **支持内容类型**：视频(av/BV)和番剧(ss/ep)
- **图片质量**：返回原始大小的封面图片，不受尺寸限制
- **注意事项**：不支持直接传入链接参数，必须通过引用消息触发

### 5. B站账号登录与状态查询

超级用户可以登录B站账号，获取更多内容和更高清晰度：

```bash
bili登录  # 生成二维码进行B站账号登录
bili状态  # 查询当前B站账号登录状态
```

- 登录后可以获取更多需要登录才能查看的内容和更高清晰度的视频
- 支持凭证自动刷新，保持登录状态长期有效
- 状态查询功能可以检查当前凭证的有效性和是否需要刷新等信息

## 安装要求

### 依赖库

插件依赖以下Python库：

```python
requests>=2.28.0
tqdm>=4.64.0
argparse>=1.4.0
qrcode>=7.3.1
pillow>=9.0.0
pretty-errors>=1.2.25
bilibili-api-python (注意：必须安装此包，而不是bilibili-api)
aiofiles
jinja2
bs4
```

### 外部依赖

- **FFmpeg**：用于视频处理和合并，必须安装并添加到系统PATH

#### FFmpeg安装方法

- **Windows**：
  1. 从[FFmpeg官网](https://ffmpeg.org/download.html)下载
  2. 解压到任意目录
  3. 将FFmpeg的bin目录添加到系统PATH环境变量

- **macOS**：

  ```bash
  brew install ffmpeg
  ```

- **Linux**：

  ```bash
  # Debian/Ubuntu
  apt install ffmpeg

  # CentOS/RHEL
  yum install ffmpeg
  ```

## 配置选项

插件提供多种配置选项，可以通过机器人配置系统进行设置：

| 配置项                     | 默认值 | 说明                                                                          |
| -------------------------- | ------ | ----------------------------------------------------------------------------- |
| DEFAULT_BILIBILI_PARSE     | True   | 被动b站解析进群默认开关状态                                                   |
| CACHE_TTL                  | 5      | 被动解析缓存时间（分钟），同一链接在此时间内同一会话不重复解析，设为0关闭缓存 |
| ENABLE_MINIAPP_PARSE       | True   | 是否在被动解析中解析QQ小程序/JSON卡片中的B站链接                              |
| RENDER_AS_IMAGE            | True   | 是否将解析结果渲染为图片                                                      |
| AUTO_DOWNLOAD_MAX_DURATION | 10     | 自动下载最大视频时长（分钟），设为0关闭时长限制                               |
| MANUAL_DOWNLOAD_MAX_DURATION | 20   | 手动下载最大视频时长（分钟），设为0关闭时长限制，超级用户不受影响             |

## 使用示例

### 被动解析

当有人在群聊中发送B站链接时，机器人会自动解析并发送内容信息：

```text
https://www.bilibili.com/video/BV1xx411c7mD
```

### 下载视频

```bash
bili下载 https://www.bilibili.com/video/BV1xx411c7mD
bili下载 BV1xx411c7mD
```

### 引用消息下载

引用一条包含B站链接的消息，然后发送：

```bash
bili下载
```

### 获取封面图片

引用一条包含B站链接的消息，然后发送：

```bash
bili封面
```

或者使用别名：

```bash
b站封面
```

### 控制自动下载

```bash
bili自动下载 on
```

### 查询账号状态

```bash
bili状态
```

## 注意事项

1. 视频下载功能需要FFmpeg支持，请确保正确安装
2. 高清晰度视频下载可能需要B站账号登录
3. 下载的视频文件会在配置的过期时间后自动清理
4. 自动下载功能默认有视频时长限制，避免下载过大的文件
5. 视频大小超过100MB时会自动降低分辨率，确保发送成功率
6. **bili封面命令只能通过引用消息触发**，不支持直接在命令后添加链接参数
7. 封面功能目前仅支持视频和番剧内容，其他类型内容暂不支持
8. 请合理使用下载功能，避免频繁大量下载导致IP被限制
9. 本插件仅使用官方API，不支持下载会员专享内容

## 常见问题

### 视频下载失败

- 检查FFmpeg是否正确安装并添加到PATH
- 检查是否需要登录B站账号（高清晰度视频）
- 检查网络连接是否正常
- 检查视频是否为会员专享内容（本插件仅使用官方API，不支持下载会员专享内容）

### 视频发送超时

- 可以通过增加 `SEND_VIDEO_TIMEOUT` 配置项的值来延长超时时间
- 增加 `SEND_VIDEO_MAX_RETRIES` 配置项的值来增加重试次数
- 降低 `VIDEO_DOWNLOAD_QUALITY` 配置项的值来下载更小的视频文件

### 解析结果不显示

- 检查相应内容类型的解析是否已启用
- 检查缓存设置，可能是短时间内重复解析被跳过

### 自动下载不工作

- 检查是否已为当前群聊开启自动下载功能
- 检查视频时长是否超过限制（默认10分钟）
- 检查存储空间是否充足

### bili封面命令无响应

- 确保使用了引用消息的方式触发命令，而不是直接发送命令
- 检查引用的消息中是否包含有效的B站链接
- 确认内容类型是否为支持的视频或番剧
- 检查网络连接是否正常

## 许可证

本插件基于MIT许可证开源。
