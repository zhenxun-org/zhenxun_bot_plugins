# B站内容解析插件 (parse_bilibili)

这是一个功能强大的B站内容解析插件，支持视频、直播、专栏/动态、番剧等多种B站内容的解析和下载功能。

## 功能特点

### 1. 被动解析
自动监听消息中的B站链接，并发送解析结果（可配置渲染成图片）。
- 支持多种内容类型：
  - 视频 (av/BV号)
  - 直播
  - 专栏 (cv号)
  - 动态 (t.bili/opus)
  - 番剧/影视 (ss/ep号)
  - 用户空间 (space)
- 支持短链接 (b23.tv)
- 支持小程序/卡片解析（可配置开启/关闭）
- 默认配置下，5分钟内同一链接在同一会话不重复解析

### 2. 手动视频下载
使用命令手动下载B站视频：
```
bili下载 [链接/ID]
b站下载 [链接/ID]
```
- 支持视频链接、av/BV号、引用包含链接的消息或卡片
- 此命令不会发送预览和处理过程消息，只会发送最终视频（如果成功）

### 3. 自动下载控制
管理员可以控制群聊中的自动下载功能：
```
bili自动下载 on    # 为当前群聊开启视频自动下载
bili自动下载 off   # 为当前群聊关闭视频自动下载
```
- 开启后，当被动解析到视频链接时，会自动执行下载并发送视频文件

### 4. B站账号登录
超级用户可以登录B站账号，获取更多内容和更高清晰度：
```
bili登录  # 生成二维码进行B站账号登录
```
- 登录后可以获取更多需要登录才能查看的内容和更高清晰度的视频

## 安装要求

### 依赖库
插件依赖以下Python库：
```
requests>=2.28.0
tqdm>=4.64.0
argparse>=1.4.0
qrcode>=7.3.1
pillow>=9.0.0
pretty-errors>=1.2.25
bilibili-api-python (注意：必须安装此包，而不是bilibili-api)
aiofiles
jinja2
bs4
```

### 外部依赖
- **FFmpeg**：用于视频处理和合并，必须安装并添加到系统PATH

#### FFmpeg安装方法
- **Windows**：
  1. 从[FFmpeg官网](https://ffmpeg.org/download.html)下载
  2. 解压到任意目录
  3. 将FFmpeg的bin目录添加到系统PATH环境变量

- **macOS**：
  ```bash
  brew install ffmpeg
  ```

- **Linux**：
  ```bash
  # Debian/Ubuntu
  apt install ffmpeg

  # CentOS/RHEL
  yum install ffmpeg
  ```

## 配置选项

插件提供多种配置选项，可以通过机器人配置系统进行设置：

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| DEFAULT_BILIBILI_PARSE | True | 被动b站解析进群默认开关状态 |
| CACHE_TTL | 5 | 被动解析缓存时间（分钟），同一链接在此时间内同一会话不重复解析，设为0关闭缓存 |
| ENABLE_MINIAPP_PARSE | True | 是否在被动解析中解析QQ小程序/JSON卡片中的B站链接 |
| RENDER_AS_IMAGE | True | 是否将解析结果渲染为图片 |
| AUTO_DOWNLOAD_MAX_DURATION | 10 | 自动下载最大视频时长（分钟），设为0关闭时长限制 |
| VIDEO_FILE_EXPIRY_DAYS | 1 | 视频文件过期时间(天)，超过此时间自动清理，设为0关闭自动清理 |

## 使用示例

### 被动解析
当有人在群聊中发送B站链接时，机器人会自动解析并发送内容信息：
```
https://www.bilibili.com/video/BV1xx411c7mD
```

### 下载视频
```
bili下载 https://www.bilibili.com/video/BV1xx411c7mD
bili下载 BV1xx411c7mD
```

### 引用消息下载
引用一条包含B站链接的消息，然后发送：
```
bili下载
```

### 控制自动下载
```
bili自动下载 on
```

## 注意事项

1. 视频下载功能需要FFmpeg支持，请确保正确安装
2. 高清晰度视频下载可能需要B站账号登录
3. 下载的视频文件会在配置的过期时间后自动清理
4. 自动下载功能默认有视频时长限制，避免下载过大的文件
5. 请合理使用下载功能，避免频繁大量下载导致IP被限制
6. 本插件仅使用官方API，不支持下载会员专享内容

## 常见问题

### 视频下载失败
- 检查FFmpeg是否正确安装并添加到PATH
- 检查是否需要登录B站账号（高清晰度视频）
- 检查网络连接是否正常
- 检查视频是否为会员专享内容（本插件仅使用官方API，不支持下载会员专享内容）

### 解析结果不显示
- 检查相应内容类型的解析是否已启用
- 检查缓存设置，可能是短时间内重复解析被跳过

### 自动下载不工作
- 检查是否已为当前群聊开启自动下载功能
- 检查视频时长是否超过限制
- 检查存储空间是否充足

## 许可证

本插件基于MIT许可证开源。
